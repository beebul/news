<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text-Only News Browser</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-900 text-gray-300 p-4 md:p-8 terminal">

    <div class="max-w-3xl mx-auto">
        <h1 class="text-2xl font-bold text-blue-400 mb-4">> Updates</h1>

        <!-- Region Tabs -->
        <div class="flex space-x-2 mb-4">
            <button data-region="BBC UK" class="region-tab active:bg-blue-600 bg-gray-700 text-white py-2 px-4 rounded-lg">
                BBC UK
            </button>
            <button data-region="ABC Australia" class="region-tab bg-gray-800 hover:bg-gray-700 text-gray-400 py-2 px-4 rounded-lg">
                ABC Aus
            </button>
            <button data-region="BBC Australia" class="region-tab bg-gray-800 hover:bg-gray-700 text-gray-400 py-2 px-4 rounded-lg">
                BBC Aust
            </button>
        </div>

        <!-- Refresh Button -->
       <br> <button id="refresh-button" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg mb-4 w-full md:w-auto">
            Refresh
        </button>

        <!-- Status Messages -->
        <div id="status" class="my-4"></div>

        <!-- Headlines List -->
        <div id="headlines-list" class="space-y-2">
            <!-- Headlines will be injected here -->
        </div>

    </div>

    <script type="module">
        // --- CONFIGURATION ---
        // This is the main API key for the Gemini model.
        // It's intentionally left blank, as the environment will provide it.
        const apiKey = "AIzaSyALL9KBZ--RzZhdJ5h43jQGDUOIIHC0aak";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const queryMap = {
            "BBC UK": "current top 8 news headlines from BBC UK",
            "ABC Australia": "current top 8 news headlines from ABC News Australia",
            "BBC Australia": "current top 8 news headlines from BBC News about Australia"
        };

        let currentRegion = "BBC UK";
        let activeStoryElement = null;

        // --- DOM ELEMENTS ---
        const regionTabs = document.querySelectorAll('.region-tab');
        const refreshButton = document.getElementById('refresh-button');
        const headlinesList = document.getElementById('headlines-list');
        const status = document.getElementById('status');

        // --- GEMINI API CALLER ---
        /**
         * Generic function to call the Gemini API.
         * @param {string} userQuery - The user's prompt.
         * @param {object | null} systemInstruction - The system prompt.
         * @param {object[] | null} tools - Tools, e.g., Google Search.
         * @param {number} retries - Number of retries for exponential backoff.
         * @returns {Promise<string>} - The text response from the model.
         */
        async function callGemini(userQuery, systemInstruction = null, tools = null, retries = 3) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                ...(systemInstruction && { systemInstruction }),
                ...(tools && { tools }),
            };

            let delay = 1000; // Initial delay 1s
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        throw new Error("Invalid API response structure or empty content.");
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error.message);
                    if (i === retries - 1) {
                        throw new Error(`Failed to call Gemini API after ${retries} attempts: ${error.message}`);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        // --- CORE LOGIC ---

        /**
         * Fetches *simulated* headlines (no search) to ensure a list is always generated.
         */
        async function fetchNews(region) {
            setLoading(true, "Fetching headlines...");
            headlinesList.innerHTML = ''; // Clear old headlines

            try {
                const userQuery = `Generate 8 current-sounding, plausible news headlines for ${queryMap[region]}. Respond ONLY with the 8 headlines, each on a new line. Do not number them or use markdown.`;
                const systemInstruction = {
                    parts: [{ text: "You are a news headline simulator. Provide a clean list of headlines, one per line." }]
                };

                // Note: 'tools' is intentionally null. This is a pure text generation call.
                const responseText = await callGemini(userQuery, systemInstruction, null);
                
                const headlines = responseText.trim().split('\n').filter(Boolean);

                if (headlines.length === 0) {
                    throw new Error("Model returned an empty list of headlines.");
                }

                renderHeadlines(headlines);
                setLoading(false);

            } catch (error) {
                console.error("Error fetching headlines:", error);
                setLoading(false, `Error: ${error.message}`);
            }
        }

        /**
         * Fetches the full story summary (with search) for a given headline topic.
         */
        async function viewStory(headlineText, storyElement) {
            // Close any previously opened story
            if (activeStoryElement && activeStoryElement !== storyElement) {
                activeStoryElement.style.display = 'none';
                activeStoryElement.innerHTML = ''; // Clear content
            }
            activeStoryElement = storyElement;

            // If story is already open, close it
            if (storyElement.style.display === 'block') {
                storyElement.style.display = 'none';
                storyElement.innerHTML = '';
                return;
            }

            // Show story element with a loading state
            storyElement.style.display = 'block';
            storyElement.innerHTML = `
                <div class="flex items-center space-x-2">
                    <div class="loading-spinner"></div>
                    <span>Fetching plain-text story for: "${headlineText}"...</span>
                </div>`;

            try {
                const userQuery = `Search for real-time news about the following topic: "${headlineText}". Then, provide a comprehensive, multi-paragraph, plain-text extraction and summary of the full story. Format it as unformatted text, perfect for a text-only terminal browser.`;
                const systemInstruction = {
                    parts: [{ text: "You are a plain-text news summarizer. You provide detailed, unformatted text summaries based on real-time search results. Do not use markdown." }]
                };
                const tools = [{ "google_search": {} }];

                const storyText = await callGemini(userQuery, systemInstruction, tools);

                // Populate the story element with the full text
                storyElement.innerHTML = storyText;

            } catch (error) {
                console.error("Error fetching story:", error);
                storyElement.innerHTML = `<span class="text-red-400">Error: Could not load story. ${error.message}</span>`;
            }
        }

        // --- RENDERING & UI ---

        /**
         * Renders the list of headlines.
         */
        function renderHeadlines(headlines) {
            headlinesList.innerHTML = ''; // Clear previous list
            headlines.forEach((headline, index) => {
                const headlineItem = document.createElement('div');
                
                const headlineText = document.createElement('div');
                headlineText.className = "headline text-lg text-blue-300 p-2 rounded-lg";
                headlineText.textContent = `> ${headline}`;
                
                const storyContent = document.createElement('div');
                storyContent.className = "story-content";
                storyContent.id = `story-${index}`;
                
                headlineText.onclick = () => viewStory(headline, storyContent);
                
                headlineItem.appendChild(headlineText);
                headlineItem.appendChild(storyContent);
                headlinesList.appendChild(headlineItem);
            });
        }

        /**
         * Sets the loading/status message.
         */
        function setLoading(isLoading, message = "") {
            if (isLoading) {
                status.innerHTML = `
                    <div class="flex items-center space-x-2 text-yellow-400">
                        <div class="loading-spinner"></div>
                        <span>${message}</span>
                    </div>`;
                refreshButton.disabled = true;
                refreshButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                status.innerHTML = message ? `<span class="text-red-400">${message}</span>` : '';
                refreshButton.disabled = false;
                refreshButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * Handles region tab switching.
         */
        function setRegion(region) {
            currentRegion = region;
            regionTabs.forEach(tab => {
                if (tab.dataset.region === region) {
                    tab.classList.add('active:bg-blue-600', 'bg-gray-700', 'text-white');
                    tab.classList.remove('bg-gray-800', 'hover:bg-gray-700', 'text-gray-400');
                } else {
                    tab.classList.remove('active:bg-blue-600', 'bg-gray-700', 'text-white');
                    tab.classList.add('bg-gray-800', 'hover:bg-gray-700', 'text-gray-400');
                }
            });
            // Automatically fetch news for the new region
            fetchNews(currentRegion);
        }

        // --- INITIALIZATION ---
        regionTabs.forEach(tab => {
            tab.addEventListener('click', () => setRegion(tab.dataset.region));
        });

        refreshButton.addEventListener('click', () => fetchNews(currentRegion));

        // Initial load
        setRegion(currentRegion);

    </script>
</body>

</html>





