<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teletext</title>
    <!-- Link to the external stylesheet -->
    <link rel="stylesheet" href="style2.css">
</head>
<body>

    <div class="container">
        <h1>Teletext</h1>

        <!-- Tab Bar for regions -->
        <div class="tab-bar">
            <button class="tab-button active" data-region="UK">BBC UK</button>
            <button class="tab-button" data-region="ABC_AU">ABC Australia</button>
            <button class="tab-button" data-region="BBC_AU">BBC Australia</button>
        </div>

        <button id="refresh-button">Refresh</button>
        
        <!-- Status for loading, errors, etc. -->
        <div id="status-container"></div>
        
        <!-- List where headlines will be injected -->
        <div id="headlines-list"></div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        let proxyApiUrl = "";
        let isConfigValid = false;
        const CACHE_DURATION_MS = 1000 * 60 * 10; // 10 Minutes Cache

        // --- APP STATE ---
        let currentRegion = "UK";
        let storyCache = {}; 
        let headlineCache = JSON.parse(localStorage.getItem('teletext_headlines') || '{}');

        // --- DOM ELEMENTS ---
        const headlinesList = document.getElementById('headlines-list');
        const statusContainer = document.getElementById('status-container');
        const refreshButton = document.getElementById('refresh-button');
        const tabButtons = document.querySelectorAll('.tab-button');

        const queryMap = {
            UK: {
                query: "Use Google Search to find the latest news from 'BBC News UK'. Scan the Top Stories, Politics, Business, Technology, and Entertainment sections. Compile a list of 20 distinct, current headlines. Return ONLY the headline text, one per line. Ensure you find at least 15 items.",
                storySystem: "You are a news archivist. The user will provide a headline. Find the most relevant, real-time news story for that headline using Google Search, focusing on BBC UK. Respond with a comprehensive, multi-paragraph, plain-text summary of the full article. Do not add any of your own commentary. Just return the plain text of the story."
            },
            ABC_AU: {
                query: "Use Google Search to find the latest news from 'ABC News Australia'. Scan Top Stories, Just In, Politics, and Business. Compile a list of 20 distinct, current headlines. Return ONLY the headline text, one per line. Ensure you find at least 15 items.",
                storySystem: "You are a news archivist. The user will provide a headline. Find the most relevant, real-time news story for that headline using Google Search, focusing on ABC News (Australia). Respond with a comprehensive, multi-paragraph, plain-text summary of the full article. Do not add any of your own commentary. Just return the plain text of the story."
            },
            BBC_AU: {
                query: "Use Google Search to find the latest news from BBC News regarding Australia. Look for stories in the 'Australia' section, but also check World News, Business, and Sport for Australian topics. Compile a list of 20 distinct headlines. Return ONLY the headline text, one per line.",
                storySystem: "You are a news archivist. The user will provide a headline. Find the most relevant, real-time news story for that headline using Google Search, focusing on BBC News Australia. Respond with a comprehensive, multi-paragraph, plain-text summary of the full article. Do not add any of your own commentary. Just return the plain text of the story."
            }
        };

        // --- INITIALIZATION ---
        async function initApp() {
            try {
                const response = await fetch('config.json');
                if (!response.ok) throw new Error("config.json not found");
                const config = await response.json();
                
                proxyApiUrl = config.proxyApiUrl;

                if (!proxyApiUrl || proxyApiUrl.includes("your-name")) {
                    showConfigError("The 'proxyApiUrl' in config.json is not set correctly.");
                } else {
                    isConfigValid = true;
                    refreshButton.disabled = false;
                    
                    if (!loadHeadlinesFromCache(currentRegion)) {
                        fetchNews(false); 
                    }
                }
            } catch (error) {
                console.warn("Config load failed:", error);
                showConfigInputUI();
            }
        }

        function showConfigError(msg) {
             statusContainer.innerHTML = `<div class="status-message error"><strong>Setup Error:</strong> ${msg}</div>`;
             refreshButton.disabled = true;
        }

        function showConfigInputUI() {
            statusContainer.innerHTML = `
                <div class="status-message error" style="flex-direction: column; align-items: flex-start;">
                    <strong>Config Missing:</strong> Please create 'config.json' or enter your Cloudflare URL below to test:<br>
                    <input type="text" id="manual-url" placeholder="https://news-proxy.name.workers.dev" style="width: 100%; margin-top: 5px; padding: 5px;">
                    <button onclick="window.setManualUrl()" style="margin-top: 5px; cursor: pointer;">Set URL</button>
                </div>`;
            
            window.setManualUrl = () => {
                const url = document.getElementById('manual-url').value.trim();
                if (url) {
                    proxyApiUrl = url;
                    isConfigValid = true;
                    refreshButton.disabled = false;
                    statusContainer.innerHTML = '';
                    fetchNews(false);
                }
            };
        }

        // --- CACHING FUNCTIONS ---
        function loadHeadlinesFromCache(region) {
            const cached = headlineCache[region];
            const now = Date.now();
            if (cached && (now - cached.timestamp < CACHE_DURATION_MS)) {
                headlinesList.innerHTML = cached.html;
                const newHeadlines = headlinesList.querySelectorAll('.headline');
                newHeadlines.forEach((hl, index) => {
                     hl.onclick = () => viewStory(hl, document.getElementById(`story-${index}`));
                });
                const minutesOld = Math.floor((now - cached.timestamp) / 60000);
                setStatus(`Updated ${minutesOld} min ago (${newHeadlines.length} stories)`, false);
                return true;
            }
            return false;
        }

        function saveHeadlinesToCache(region, htmlContent) {
            headlineCache[region] = {
                timestamp: Date.now(),
                html: htmlContent
            };
            localStorage.setItem('teletext_headlines', JSON.stringify(headlineCache));
        }

        // --- API CALLER ---
        async function callGemini(userQuery, systemInstruction, useSearch) {
            if (!isConfigValid) throw new Error("App not configured.");
            const proxyPayload = {
                userQuery,
                systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : null,
                tools: useSearch ? [{ "google_search": {} }] : null
            };

            let lastError = null;
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const response = await fetch(proxyApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proxyPayload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Proxy Error: ${response.status} ${response.statusText} - ${errorBody}`);
                    }
                    const result = await response.json();
                    if (result.text) return result.text;
                    else throw new Error("Invalid proxy response structure.");
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error.message);
                    lastError = error;
                    await new Promise(res => setTimeout(res, 1000 * attempt)); 
                }
            }
            throw new Error(`Failed to call proxy after 3 attempts: ${lastError.message}`);
        }

        function setStatus(message, isLoading = false, isError = false) {
            statusContainer.innerHTML = ''; 
            if (message) {
                const statusMessage = document.createElement('div');
                statusMessage.className = 'status-message';
                if (isError) statusMessage.classList.add('error');
                if (isLoading) {
                    const spinner = document.createElement('div');
                    spinner.className = 'loading-spinner';
                    statusMessage.appendChild(spinner);
                }
                const textNode = document.createElement('span');
                textNode.textContent = message;
                statusMessage.appendChild(textNode);
                statusContainer.appendChild(statusMessage);
            }
        }

        // --- FETCH HEADLINES ---
        async function fetchNews(forceRefresh = false) {
            if (!isConfigValid) return;
            if (!forceRefresh && loadHeadlinesFromCache(currentRegion)) return;

            setStatus("Searching for live headlines...", true);
            headlinesList.innerHTML = '';
            refreshButton.disabled = true;

            try {
                const regionData = queryMap[currentRegion];
                const rawText = await callGemini(regionData.query, null, true);
                
                // --- GARBAGE FILTER ---
                // Identify words/patterns that indicate the AI is chatting, not listing headlines.
                const blocklist = [
                    "google search", "unable to", "limited number", "distinct", 
                    "found:", "following is", "apologies", "sorry", "non-bbc", 
                    "sourced", "headlines found", "search results", "please note"
                ];

                const headlines = rawText.split('\n')
                    .map(line => line.replace(/^(\d+\.|-|\*)\s*/, '').trim()) // Remove bullets
                    .filter(line => {
                        if (line.length < 10) return false; // Too short
                        const lower = line.toLowerCase();
                        // Check if line contains any blocklisted phrase
                        if (blocklist.some(phrase => lower.includes(phrase))) return false;
                        // Check if line ends with a colon (intro text)
                        if (line.endsWith(':')) return false;
                        return true;
                    }); 

                if (!headlines || headlines.length === 0) throw new Error("Could not parse headlines from API response.");

                headlines.forEach((headlineText, index) => {
                    const item = document.createElement('div');
                    item.className = 'headline-item';
                    const headlineEl = document.createElement('div');
                    headlineEl.className = 'headline';
                    headlineEl.textContent = headlineText;
                    headlineEl.dataset.index = index;
                    const storyContentEl = document.createElement('div');
                    storyContentEl.className = 'story-content';
                    storyContentEl.id = `story-${index}`;
                    headlineEl.onclick = () => viewStory(headlineEl, storyContentEl);
                    item.appendChild(headlineEl);
                    item.appendChild(storyContentEl);
                    headlinesList.appendChild(item);
                });

                saveHeadlinesToCache(currentRegion, headlinesList.innerHTML);
                setStatus(`Updated just now (${headlines.length} stories)`, false);
            } catch (error) {
                console.error("Error fetching headlines:", error);
                setStatus(`Error: ${error.message}`, false, true);
            } finally {
                refreshButton.disabled = false;
            }
        }

        // --- VIEW STORY ---
        async function viewStory(headlineEl, storyContentEl) {
            if (!isConfigValid || !storyContentEl) return;
            const headlineText = headlineEl.textContent;

            if (storyContentEl.style.display === 'block') {
                storyContentEl.style.display = 'none';
                return;
            }

            if (storyCache[headlineText]) {
                storyContentEl.textContent = storyCache[headlineText];
                storyContentEl.style.display = 'block';
                return;
            }

            storyContentEl.textContent = "Loading story...";
            storyContentEl.style.display = 'block';

            try {
                const regionData = queryMap[currentRegion];
                const storyText = await callGemini(headlineText, regionData.storySystem, true);
                storyContentEl.textContent = storyText;
                storyCache[headlineText] = storyText; 
            } catch (error) {
                console.error("Error fetching story:", error);
                storyContentEl.textContent = `Error loading story: ${error.message}`;
            }
        }

        function setRegion(e) {
            const newRegion = e.target.dataset.region;
            if (newRegion === currentRegion) return;
            currentRegion = newRegion;
            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.region === newRegion);
            });
            fetchNews(false);
        }

        tabButtons.forEach(btn => {
            btn.addEventListener('click', setRegion);
        });

        refreshButton.addEventListener('click', () => fetchNews(true));

        initApp();
    </script>
</body>
</html>




