<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teletext News</title>
    <!-- Link to the external stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <h1>Teletext</h1>

        <!-- Tab Bar for regions -->
        <div class="tab-bar">
            <button class="tab-button active" data-region="UK">BBC UK</button>
            <button class="tab-button" data-region="ABC_AU">ABC Australia</button>
            <button class="tab-button" data-region="BBC_AU">BBC Australia</button>
        </div>

        <button id="refresh-button">Refresh Headlines</button>
        
        <!-- Status for loading, errors, etc. -->
        <div id="status-container"></div>
        
        <!-- List where headlines will be injected -->
        <div id="headlines-list"></div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        // The app loads 'config.json' to find the API URL.
        let proxyApiUrl = "";
        let isConfigValid = false;

        // --- APP STATE ---
        let currentRegion = "UK";
        let storyCache = {}; // Cache for fetched stories

        // --- DOM ELEMENTS ---
        const headlinesList = document.getElementById('headlines-list');
        const statusContainer = document.getElementById('status-container');
        const refreshButton = document.getElementById('refresh-button');
        const tabButtons = document.querySelectorAll('.tab-button');

        const queryMap = {
            UK: {
                query: "Use Google Search to find the current top news headlines on the 'BBC News UK' homepage right now. List the top 20 distinct headlines you find. Return ONLY the headline text, one per line. Do not include summaries, links, or introductory text.",
                storySystem: "You are a news archivist. The user will provide a headline. Find the most relevant, real-time news story for that headline using Google Search, focusing on BBC UK. Respond with a comprehensive, multi-paragraph, plain-text summary of the full article. Do not add any of your own commentary. Just return the plain text of the story."
            },
            ABC_AU: {
                query: "Use Google Search to find the current top news headlines on the 'ABC News Australia' homepage right now. List the top 20 distinct headlines you find. Return ONLY the headline text, one per line. Do not include summaries, links, or introductory text.",
                storySystem: "You are a news archivist. The user will provide a headline. Find the most relevant, real-time news story for that headline using Google Search, focusing on ABC News (Australia). Respond with a comprehensive, multi-paragraph, plain-text summary of the full article. Do not add any of your own commentary. Just return the plain text of the story."
            },
            BBC_AU: {
                // UPDATED: Broader query and stricter "no apology" instruction
                query: "Use Google Search to find the latest news stories about Australia from BBC News. Look for 'BBC News Australia' specific stories as well as general World news concerning Australia. List up to 20 distinct, recent headlines. Return ONLY the headline text, one per line. Do not include introductory text, apologies, or summaries.",
                storySystem: "You are a news archivist. The user will provide a headline. Find the most relevant, real-time news story for that headline using Google Search, focusing on BBC News Australia. Respond with a comprehensive, multi-paragraph, plain-text summary of the full article. Do not add any of your own commentary. Just return the plain text of the story."
            }
        };

        // --- INITIALIZATION: LOAD CONFIG ---
        async function initApp() {
            try {
                const response = await fetch('config.json');
                if (!response.ok) throw new Error("Could not load config.json");
                const config = await response.json();
                
                proxyApiUrl = config.proxyApiUrl;

                // Validate URL
                if (!proxyApiUrl || proxyApiUrl.includes("your-name")) {
                    showConfigError("The 'proxyApiUrl' in config.json is not set correctly.");
                } else {
                    isConfigValid = true;
                    refreshButton.disabled = false;
                    fetchNews(); // Start the app
                }
            } catch (error) {
                console.error(error);
                showConfigError("Could not load 'config.json'. Please ensure this file exists in your GitHub repository.");
            }
        }

        function showConfigError(msg) {
             statusContainer.innerHTML = `<div class="status-message error"><strong>Setup Error:</strong> ${msg}</div>`;
             refreshButton.disabled = true;
        }

        /**
         * A wrapper for the Gemini API call via the PROXY.
         */
        async function callGemini(userQuery, systemInstruction, useSearch) {
            if (!isConfigValid) throw new Error("App not configured.");

            const proxyPayload = {
                userQuery,
                systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : null,
                tools: useSearch ? [{ "google_search": {} }] : null
            };

            let lastError = null;
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const response = await fetch(proxyApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proxyPayload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Proxy Error: ${response.status} ${response.statusText} - ${errorBody}`);
                    }

                    const result = await response.json();
                    
                    if (result.text) {
                        return result.text;
                    } else {
                        throw new Error("Invalid proxy response structure or empty content.");
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error.message);
                    lastError = error;
                    await new Promise(res => setTimeout(res, 1000 * attempt)); // Exponential backoff
                }
            }
            throw new Error(`Failed to call proxy after 3 attempts: ${lastError.message}`);
        }

        /**
         * Sets the status message, with an optional spinner.
         */
        function setStatus(message, isLoading = false, isError = false) {
            statusContainer.innerHTML = ''; // Clear previous status
            if (message) {
                const statusMessage = document.createElement('div');
                statusMessage.className = 'status-message';
                if (isError) {
                    statusMessage.classList.add('error');
                }

                if (isLoading) {
                    const spinner = document.createElement('div');
                    spinner.className = 'loading-spinner';
                    statusMessage.appendChild(spinner);
                }
                
                const textNode = document.createElement('span');
                textNode.textContent = message;
                statusMessage.appendChild(textNode);
                
                statusContainer.appendChild(statusMessage);
            }
        }

        /**
         * Fetches and displays the list of headlines.
         */
        async function fetchNews() {
            if (!isConfigValid) return;

            setStatus("Searching for live headlines...", true);
            headlinesList.innerHTML = '';
            storyCache = {}; // Clear the cache on a new refresh
            refreshButton.disabled = true;

            try {
                const regionData = queryMap[currentRegion];
                
                // USE Google Search (true) to find the headlines
                const rawText = await callGemini(regionData.query, null, true);
                
                // Robust Parsing
                const headlines = rawText.split('\n')
                    .map(line => line.replace(/^(\d+\.|-|\*)\s*/, '').trim())
                    .filter(line => line.length > 10 && !line.startsWith("Source") && !line.includes("unable to find")); 

                if (!headlines || headlines.length === 0) {
                    throw new Error("Could not parse headlines from API response.");
                }

                headlines.forEach((headlineText, index) => {
                    const item = document.createElement('div');
                    item.className = 'headline-item';
                    
                    const headlineEl = document.createElement('div');
                    headlineEl.className = 'headline';
                    headlineEl.textContent = headlineText;
                    headlineEl.dataset.index = index;
                    
                    const storyContentEl = document.createElement('div');
                    storyContentEl.className = 'story-content';
                    storyContentEl.id = `story-${index}`;
                    
                    item.appendChild(headlineEl);
                    item.appendChild(storyContentEl);
                    headlinesList.appendChild(item);
                });

                setStatus(""); // Clear loading status
            } catch (error) {
                console.error("Error fetching headlines:", error);
                setStatus(`Error fetching headlines: ${error.message}`, false, true);
            } finally {
                if (isConfigValid) {
                    refreshButton.disabled = false;
                }
            }
        }

        /**
         * Fetches and displays a single story when a headline is clicked.
         */
        async function viewStory(headlineEl) {
            if (!isConfigValid) return;

            const headlineText = headlineEl.textContent;
            const storyId = `story-${headlineEl.dataset.index}`;
            const storyContentEl = document.getElementById(storyId);

            if (!storyContentEl) return;

            // Toggle visibility
            if (storyContentEl.style.display === 'block') {
                storyContentEl.style.display = 'none';
                return;
            }

            // Check cache first
            if (storyCache[headlineText]) {
                storyContentEl.textContent = storyCache[headlineText];
                storyContentEl.style.display = 'block';
                return;
            }

            // Fetch
            storyContentEl.textContent = "Loading story...";
            storyContentEl.style.display = 'block';

            try {
                const regionData = queryMap[currentRegion];
                const storyText = await callGemini(headlineText, regionData.storySystem, true);
                
                storyContentEl.textContent = storyText;
                
                // Cache result
                storyCache[headlineText] = storyText;
                
            } catch (error) {
                console.error("Error fetching story:", error);
                storyContentEl.textContent = `Error loading story: ${error.message}`;
            }
        }

        /**
         * Changes the active region and fetches new news.
         */
        function setRegion(e) {
            const newRegion = e.target.dataset.region;
            if (newRegion === currentRegion) return;
            
            currentRegion = newRegion;
            
            tabButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.region === newRegion);
            });
            
            fetchNews();
        }

        // --- Event Listeners ---
        headlinesList.addEventListener('click', (e) => {
            if (e.target.classList.contains('headline')) {
                viewStory(e.target);
            }
        });

        tabButtons.forEach(btn => {
            btn.addEventListener('click', setRegion);
        });

        refreshButton.addEventListener('click', fetchNews);

        // Start
        initApp();

    </script>
</body>
</html>
