<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teletext Deals</title>
    <!-- Reuse the existing style.css so it matches the News app -->
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <div class="container">
        <h1>Teletext Deals: OzBargain</h1>

        <!-- Tab Bar for Deal Categories -->
        <div class="tab-bar">
            <button class="tab-button active" data-region="TOP">Top Deals</button>
            <button class="tab-button" data-region="NEW">New Deals (Live)</button>
            <button class="tab-button" data-region="FREE">Freebies</button>
        </div>

        <button id="refresh-button">Refresh Deals</button>
        
        <div id="status-container"></div>
        
        <div id="headlines-list"></div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        let proxyApiUrl = "";
        let isConfigValid = false;
        // 2 Minutes Cache for Deals (they expire fast)
        const CACHE_DURATION_MS = 1000 * 60 * 2; 

        // --- APP STATE ---
        let currentRegion = "TOP";
        let storyCache = {}; 
        let headlineCache = JSON.parse(localStorage.getItem('teletext_deals') || '{}');

        // --- DOM ELEMENTS ---
        const headlinesList = document.getElementById('headlines-list');
        const statusContainer = document.getElementById('status-container');
        const refreshButton = document.getElementById('refresh-button');
        const tabButtons = document.querySelectorAll('.tab-button');

        // --- PROMPT ENGINEERING ---
        const queryMap = {
            TOP: {
                // Strategy: RSS FEED (Popular Deals)
                targetUrl: "https://www.ozbargain.com.au/deals/feed",
                query: "You have been provided with the raw RSS feed data for 'Popular Deals' from OzBargain in the Context Data. Parse this XML/RSS data. Extract the titles of the top 20 deals. Format each line strictly as: 'Item Name'. Do not use markdown formatting. Return ONLY the list, one per line.",
                useSearch: false,
                storySystem: "You are a deal hunter. The user will provide a deal title. Find the details of this specific deal on OzBargain using Google Search. Summarize the following: 1) The Price, 2) The Retailer, 3) The Coupon Code (if any), 4) The Expiry Date, and 5) A brief description of why it is a good deal (or key comments/warnings from users). Format as a clean, plain-text memo."
            },
            NEW: {
                // Strategy: RSS FEED (The new backend feature)
                targetUrl: "https://www.ozbargain.com.au/feed/new",
                query: "You have been provided with the raw RSS feed data from OzBargain in the Context Data. Parse this XML/RSS data. Extract the titles of the 20 most recent items. Format each line strictly as: 'Item Name'. Do not use markdown formatting like bold or italics. Return ONLY the list, one per line.",
                useSearch: false, 
                storySystem: "You are a deal hunter. Summarize this deal from OzBargain using Google Search."
            },
            FREE: {
                // Strategy: RSS FEED (Freebies Category)
                targetUrl: "https://www.ozbargain.com.au/cat/freebies/feed",
                query: "You have been provided with the raw RSS feed data for 'Freebies' from OzBargain in the Context Data. Parse this XML/RSS data. Extract the titles of the top 20 freebie items. Format each line strictly as: 'Item Name'. Do not use markdown formatting. Return ONLY the list, one per line.",
                useSearch: false,
                storySystem: "You are a deal hunter. The user will provide a freebie title. Find the details of this specific deal on OzBargain using Google Search. Summarize how to claim the freebie, any eligibility requirements (e.g. new customers only), and when it expires. Format as a clean, plain-text memo."
            }
        };

        // --- INITIALIZATION ---
        async function initApp() {
            try {
                // Reuses the SAME config file as your news app
                const response = await fetch('config.json');
                if (!response.ok) throw new Error("config.json not found");
                const config = await response.json();
                proxyApiUrl = config.proxyApiUrl;

                if (!proxyApiUrl || proxyApiUrl.includes("your-name")) {
                    showConfigError("The 'proxyApiUrl' in config.json is not set correctly.");
                } else {
                    isConfigValid = true;
                    refreshButton.disabled = false;
                    
                    // 1. Load ONLY the current region immediately to save API quota
                    fetchNews(currentRegion);

                    // REMOVED: Background pre-fetching loop
                }
            } catch (error) {
                console.warn("Config load failed:", error);
                showConfigInputUI();
            }
        }

        function showConfigError(msg) {
             statusContainer.innerHTML = `<div class="status-message error"><strong>Setup Error:</strong> ${msg}</div>`;
             refreshButton.disabled = true;
        }

        function showConfigInputUI() {
            statusContainer.innerHTML = `
                <div class="status-message error" style="flex-direction: column; align-items: flex-start;">
                    <strong>Config Missing:</strong> Please create 'config.json' or enter your Cloudflare URL below:<br>
                    <input type="text" id="manual-url" placeholder="https://..." style="width: 100%; margin-top: 5px; padding: 5px;">
                    <button onclick="window.setManualUrl()" style="margin-top: 5px; cursor: pointer;">Set URL</button>
                </div>`;
            
            window.setManualUrl = () => {
                const url = document.getElementById('manual-url').value.trim();
                if (url) {
                    proxyApiUrl = url;
                    isConfigValid = true;
                    refreshButton.disabled = false;
                    statusContainer.innerHTML = '';
                    fetchNews(false);
                }
            };
        }

        // --- CACHING FUNCTIONS ---
        function loadHeadlinesFromCache(region) {
            const cached = headlineCache[region];
            const now = Date.now();
            if (cached && (now - cached.timestamp < CACHE_DURATION_MS)) {
                headlinesList.innerHTML = cached.html;
                const newHeadlines = headlinesList.querySelectorAll('.headline');
                newHeadlines.forEach((hl, index) => {
                     hl.onclick = () => viewStory(hl, document.getElementById(`story-${index}`));
                });
                setStatus(`Updated recently`, false);
                return true;
            }
            return false;
        }

        function saveHeadlinesToCache(region, htmlContent) {
            headlineCache[region] = {
                timestamp: Date.now(),
                html: htmlContent
            };
            localStorage.setItem('teletext_deals', JSON.stringify(headlineCache));
        }

        // --- API CALLER ---
        async function callGemini(userQuery, systemInstruction, useSearch, targetUrl = null) {
            if (!isConfigValid) throw new Error("App not configured.");
            
            const proxyPayload = {
                userQuery,
                systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : null,
                tools: useSearch ? [{ "google_search": {} }] : null,
                targetUrl: targetUrl // Send the RSS URL if we have one
            };

            let lastError = null;
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const response = await fetch(proxyApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proxyPayload)
                    });
                    
                    if (response.status === 429) {
                        throw new Error("Rate Limit Exceeded. Please wait a moment.");
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`Proxy Error: ${response.status} ${response.statusText} - ${errorBody}`);
                    }
                    const result = await response.json();
                    if (result.text) return result.text;
                    else throw new Error("Invalid proxy response structure.");
                } catch (error) {
                    console.error(`Attempt ${attempt} failed:`, error.message);
                    lastError = error;
                    const waitTime = error.message.includes("Rate Limit") ? 2000 : 1000;
                    await new Promise(res => setTimeout(res, waitTime * attempt)); 
                }
            }
            throw new Error(`Failed to call proxy after 3 attempts: ${lastError.message}`);
        }

        function setStatus(message, isLoading = false, isError = false) {
            statusContainer.innerHTML = ''; 
            if (message) {
                const statusMessage = document.createElement('div');
                statusMessage.className = 'status-message';
                if (isError) statusMessage.classList.add('error');
                if (isLoading) {
                    const spinner = document.createElement('div');
                    spinner.className = 'loading-spinner';
                    statusMessage.appendChild(spinner);
                }
                const textNode = document.createElement('span');
                textNode.textContent = message;
                statusMessage.appendChild(textNode);
                statusContainer.appendChild(statusMessage);
            }
        }

        // --- FETCH HEADLINES ---
        async function fetchNews(region = currentRegion, forceRefresh = false) {
            if (!isConfigValid) return;

            // 1. Check Cache
            if (!forceRefresh && loadHeadlinesFromCache(region)) {
                return;
            }

            // 2. Show Loading
            if (region === currentRegion) {
                setStatus("Searching Deals...", true);
                headlinesList.innerHTML = '';
                refreshButton.disabled = true;
            }

            try {
                const regionData = queryMap[region];
                
                // Call Gemini with the specific strategy for this region
                const rawText = await callGemini(
                    regionData.query, 
                    null, 
                    regionData.useSearch, 
                    regionData.targetUrl
                );
                
                // Parsing logic
                const headlines = rawText.split('\n')
                    .map(line => line.replace(/^(\d+\.|-|\*)\s*/, '').trim())
                    .filter(line => line.length > 5 && !line.startsWith("Source") && !line.includes("unable to")); 

                if (!headlines || headlines.length === 0) throw new Error("Could not find deals.");

                let htmlBuffer = "";
                headlines.forEach((headlineText, index) => {
                    htmlBuffer += `
                        <div class="headline-item">
                            <div class="headline" data-index="${index}">${headlineText}</div>
                            <div class="story-content" id="story-${index}"></div>
                        </div>`;
                });

                saveHeadlinesToCache(region, htmlBuffer);

                if (region === currentRegion) {
                    loadHeadlinesFromCache(region);
                    refreshButton.disabled = false;
                }
            } catch (error) {
                console.error(`Error fetching ${region}:`, error);
                if (region === currentRegion) {
                    setStatus(`Error: ${error.message}`, false, true);
                    refreshButton.disabled = false;
                }
            }
        }

        // --- VIEW STORY ---
        async function viewStory(headlineEl, storyContentEl) {
            if (!isConfigValid || !storyContentEl) return;
            const headlineText = headlineEl.textContent;

            if (storyContentEl.style.display === 'block') {
                storyContentEl.style.display = 'none';
                return;
            }

            if (storyCache[headlineText]) {
                storyContentEl.textContent = storyCache[headlineText];
                storyContentEl.style.display = 'block';
                return;
            }

            storyContentEl.textContent = "Checking details...";
            storyContentEl.style.display = 'block';

            try {
                const regionData = queryMap[currentRegion];
                // Note: We always use search to get details of a specific deal
                const storyText = await callGemini(headlineText, regionData.storySystem, true);
                storyContentEl.textContent = storyText;
                storyCache[headlineText] = storyText; 
            } catch (error) {
                console.error("Error fetching details:", error);
                storyContentEl.textContent = `Error loading details: ${error.message}`;
            }
        }

        function setRegion(e) {
            const newRegion = e.target.dataset.region;
            if (newRegion === currentRegion) return;
            currentRegion = newRegion;
            tabButtons.forEach(btn => {
                btn.classList.toggle('active
